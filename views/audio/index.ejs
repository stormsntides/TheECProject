<% include ../partials/headerOpen %>

  <link rel="stylesheet" href="/public/customLibraries/audioPlayerVanilla/audioStyleVanilla.css">

<% include ../partials/headerClose %>
<% include ../partials/navbar-main %>

    <!-- Content down here -->
    <main>
      <div class="row">
        <div class="col s12 l2 center-align">
          <br>
          <a href="#upload-file" class="modal-trigger flow-text">Upload Song</a>
          <br>
        </div>
        <div id="audio-content" class="col s12 l8">
          <% if(files){ %>
            <% files.forEach(function(file, songIndex){ %>
              <% if(file.isAudio){ %>
                <div class="card-panel grey lighten-2">
                  <div class="right">
                    <a href="#!" class="info-hide" data-target="song-<%= songIndex %>-info"><i class="material-icons">info</i></a>
                    <a href="#delete-<%= file.songInfo._id %>" class="modal-trigger"><i class="material-icons red-text">close</i></a>
                  </div>
                  <div class="card-contents">
                    <div class="audio-player">
                      <a class="audio-control" name="playback-wrapper" href="#!">
                        <p>
                          <span class="valign-wrapper black-text">
                            <span class="audio-control" name="playback" data-icon-class="small" disabled="true"></span>
                            <%= file.songInfo.title %> - <em><%= file.songInfo.artist %></em>
                          </span>
                        </p>
                      </a>
                      <audio src="/admin/audio/stream/<%= file.filename %>" preload="metadata" type="<%= file.contentType %>" data-title="<%= file.songInfo.title %>" data-album="<%= file.songInfo.album %>" data-artist="<%= file.songInfo.artist %>" data-producer="<%= file.songInfo.producer %>" data-duration="<%= file.songInfo.duration %>"></audio>
                      <div class="audio-progress" data-show-time="true"></div>
                      <span class="audio-label" name="time"></span>
                    </div>
                    <div id="song-<%= songIndex %>-info" style="display: none">
                      <hr>
                      <p>Off of the album "<%= file.songInfo.album %>", Produced by <%= file.songInfo.producer %></p>
                      <p>"<%= file.songInfo.description %>"</p>
                      <div class="flex-container">
                        <a href="#edit-<%= file.songInfo._id %>" class="modal-trigger margin-left btn btn-flat transparent blue-text">Edit</a>
                      </div>
                    </div>
                  </div>
                  <form id="delete-<%= file.songInfo._id %>" class="modal modal-fixed-footer" action="/admin/audio/files/<%= file.songInfo._id %>?_method=DELETE" method="POST">
                    <div class="modal-content">
                      <h2 class="red-text center-align">WARNING!</h2>
                      <hr>
                      <h5 class="center-align">You are about to delete "<%= file.songInfo.title %>" by <%= file.songInfo.artist %>.</h5>
                      <p class="center-align">This action is <strong>PERMANENT</strong> and cannot be undone! Are you sure you want to delete this song?</p>
                      <br>
                      <p class="center-align"><em>"<span><%= file.songInfo.description %></span>"</em></p>
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="modal-action modal-close waves-effect waves-green btn-flat">Confirm</button>
                      <a href="#!" class="modal-action modal-close waves-effect waves-grey btn-flat">Cancel</a>
                    </div>
                  </form>
                  <form id="edit-<%= file.songInfo._id %>" class="modal modal-fixed-footer" action="/admin/audio/files/<%= file.songInfo._id %>?_method=PUT" method="POST">
                    <div class="modal-content">
                      <div class="row">
                        <div class="col s12">
                          <h4>Song Data</h4>
                        </div>
                        <div class="col s12 m6">
                          <div class="input-field">
                            <input type="text" name="song[title]" id="up-title" value="<%= file.songInfo.title %>">
                            <label for="up-title">Title</label>
                          </div>
                        </div>
                        <div class="col s12 m6">
                          <div class="input-field">
                            <input type="text" name="song[album]" id="up-album" value="<%= file.songInfo.album %>">
                            <label for="up-album">Album</label>
                          </div>
                        </div>
                        <div class="col s12 m6">
                          <div class="input-field">
                            <input type="text" name="song[artist]" id="up-artist" value="<%= file.songInfo.artist %>">
                            <label for="up-artist">Artist</label>
                          </div>
                        </div>
                        <div class="col s12 m6">
                          <div class="input-field">
                            <input type="text" name="song[producer]" id="up-producer" value="<%= file.songInfo.producer %>">
                            <label for="up-producer">Producer</label>
                          </div>
                        </div>
                        <div class="col s12">
                          <div class="input-field">
                            <textarea class="materialize-textarea" name="song[description]" id="up-description"><%= file.songInfo.description %></textarea>
                            <label for="up-description">Description</label>
                          </div>
                        </div>
                        <div class="col s12 m6">
                          <div class="input-field">
                            <input type="text" name="song[filename]" id="filename" disabled value="<%= file.songInfo.filename %>">
                            <label for="filename">Filename</label>
                          </div>
                        </div>
                        <div class="col s12 m6">
                          <div class="input-field">
                            <input type="text" name="song[contentType]" id="contentType" disabled value="<%= file.songInfo.contentType %>">
                            <label for="contentType">Content Type</label>
                          </div>
                        </div>
                        <div class="col s12 m3">
                          <div class="input-field">
                            <input disabled type="text" class="disabled" name="song[duration]" id="up-duration">
                            <label for="up-duration">Duration</label>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button class="modal-action modal-close btn btn-flat transparent waves-effect waves-green">Update</button>
                      <a href="#!" class="modal-action modal-close waves-effect waves-grey btn-flat">Cancel</a>
                    </div>
                  </form>
                </div>
              <% } else { %>
                <div class="card-panel red darken-2">
                  <div class="card-contents">
                    <p class="white-text">"<%= file.filename %>" is not an audio file and is of no use. Please delete this file from the database.</p>
                  </div>
                  <div class="card-action">
                    <form id="delete-<%= file.songInfo._id %>" class="right-align" action="/admin/audio/files/<%= file.songInfo._id %>?_method=DELETE" method="POST">
                      <button class="btn btn-flat transparent waves-effect waves-light white-text">Delete</button>
                    </form>
                  </div>
                </div>
              <% } %>
            <% }); %>
          <% } else { %>
            <h3>No files to show.</h3>
          <% } %>
        </div>
      </div>
    </main>

    <form id="upload-file" class="modal modal-fixed-footer" action="/admin/audio/upload" method="POST" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="row">
          <div class="col s12">
            <h4>Song Data</h4>
          </div>
          <div class="col s12 m6">
            <div class="input-field">
              <input type="text" name="song[title]" id="title">
              <label for="title">Title</label>
            </div>
          </div>
          <div class="col s12 m6">
            <div class="input-field">
              <input type="text" name="song[album]" id="album">
              <label for="album">Album</label>
            </div>
          </div>
          <div class="col s12 m6">
            <div class="input-field">
              <input type="text" name="song[artist]" id="artist">
              <label for="artist">Artist</label>
            </div>
          </div>
          <div class="col s12 m6">
            <div class="input-field">
              <input type="text" name="song[producer]" id="producer">
              <label for="producer">Producer</label>
            </div>
          </div>
          <div class="col s12 m3">
            <div class="input-field">
              <input readonly type="text" class="disabled" name="song[duration]" id="duration">
              <label for="duration">Duration</label>
            </div>
          </div>
          <div class="col s12">
            <div class="input-field">
              <textarea class="materialize-textarea" name="song[description]" id="description"></textarea>
              <label for="title">Description</label>
            </div>
          </div>
          <div class="col s12">
            <div class="file-field input-field">
              <div class="btn">
                <span>Browse</span>
                <input type="file" name="upload">
              </div>
              <div class="file-path-wrapper">
                <input class="file-path validate" type="text" placeholder="Select a file to upload">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-action modal-close btn btn-flat transparent waves-effect waves-green">Upload</button>
        <a href="#!" class="modal-action modal-close waves-effect waves-grey btn-flat">Cancel</a>
      </div>
    </form>

<% include ../partials/copyright %>
<% include ../partials/jquery %>
<% include ../partials/flash %>

    <script>
      $(function(){
        $(".button-collapse").sideNav({
          menuWidth: 240,
          edge: "right",
          closeOnClick: true,
          draggable: true
        });
        $(".dropdown-button").dropdown();
        $('.modal').modal();
        $("input[type='file']").on("change", function(e){
          let files = this.files;
          let $audio = $('<audio preload="metadata"></audio>');

          $audio[0].onloadedmetadata = function() {
            URL.revokeObjectURL($audio.attr("src"));
            let duration = $audio[0].duration;
            $("#duration").val(duration);
            Materialize.updateTextFields();
          };

          $audio.attr("src", URL.createObjectURL(files[0]));
        });
        $("#upload-file").on("submit", function(){
          $("#audio-content").prepend("<div class='card-panel blue darken-2 white-text'>Uploading File...<div class='loader'></div></div>");
        });
        $(".info-hide").on("click", function(){
          let dataTarget = "#" + $(this).data("target");
          $(dataTarget).slideToggle();
        });
      });
    </script>

    <script src="/public/customLibraries/audioPlayerVanilla/audioScriptVanilla.js"></script>

<% include ../partials/footer %>
